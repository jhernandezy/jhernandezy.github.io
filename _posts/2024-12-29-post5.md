---
title: EXAMEN FINAL
date: 2024-12-29 00:00:00 -05:00
categories: [Ciberseguridad, Seguridad Inform√°tica]
tags: [Procmon, Sysmon, Caldera]  # TAG names should always be lowercase
---

En este post, vamos a responder las siguientes preguntas del examen final.

# 1. ¬øC√≥mo podr√≠as utilizar Procmon y Sysmon juntos para investigar la actividad de un proceso sospechoso?

Para investigar la actividad de un procesos sospechoso, procmon puede capturar actividades en tiempo real relacionadas con el sistema de archivos, el registro y las operaciones de red, proporcionando un nivel de detalle granular para observar el comportamiento inmediato del proceso. Por otro lado, sysmon, ofrece un registro persistente de eventos clave como la creaci√≥n de procesos, conexiones de red y modificaciones en el registro. 
Al combinar ambos, se puede usar Procmon para observar actividad en tiempo real y correlacionar esa informaci√≥n con eventos hist√≥ricos capturados por Sysmon para identificar patrones o contextos adicionales.

# 1.1. Explica los tipos de eventos que Procmon y Sysmon pueden capturar de forma complementaria.

Procmon
- Captura eventos relacionados con el sistema de archivos, como la creaci√≥n, lectura y modificaci√≥n de archivos (`CreateFile`, `ReadFile`).
- Monitoreo claves de registro y su manipulaci√≥n (`RegQueryValue`, `RegSetValue`).

Sysmon
Registra eventos m√°s persistentes como:
- `ProcessCreate` (creaci√≥n de procesos).
- `ProcessAccess` (acceso a procesos).
- `FileCreateStreamHash` (creaci√≥n de flujos secundarios).
- Conexiones de red y cambios en el registro del sistema.

<div style="background-color: #f9f9f9; border-left: 6px solid #ccc; padding: 10px;">
  ‚ÑπÔ∏è <strong>Informaci√≥n √∫til:</strong> Estas herramientas se complementan porque Procmon ofrece una visi√≥n inmediata y detallada, mientras que Sysmon proporciona un historial m√°s estructurado y configurable.
</div>

# 1.2. Proporciona un ejemplo pr√°ctico de c√≥mo identificar un posible comportamiento malicioso en un proceso utilizando ambas herramientas.

Por ejemplo, supongamos que un administrador de seguridad detecta un proceso sospechoso en un sistema que podr√≠a ser parte de un malware. El proceso no tiene un nombre com√∫n y muestra un comportamiento an√≥malo, como consumir recursos inusuales o persistir en memoria.

**Paso 1: Monitoreo en tiempo real con Procmon** 
Procmon se utiliza para capturar detalles precisos y en tiempo real del proceso sospechoso:

1.	Filtro inicial: Configura Procmon para capturar eventos relacionados exclusivamente con el proceso sospechoso, utilizando su nombre o su PID (Process ID). Esto reduce el ruido y asegura que solo se analicen eventos relevantes.

2.	Observaci√≥n de actividades clave: Revisi√≥n de operaciones en el sistema de archivos, como:
- Creaci√≥n de archivos ocultos o en ubicaciones no est√°ndar.
- Escritura en directorios cr√≠ticos. Por ejemplo, `C:\Windows\System32)`
- Modificaciones al registro que podr√≠an ser persistentes, como cambios en las claves de inicio autom√°tico `(HKLM\Software\Microsoft\Windows\CurrentVersion\Run).`
- Llamadas al sistema que interact√∫an con librer√≠as sospechosas o DLLs no firmadas.

**Paso 2: Correlaci√≥n con los eventos hist√≥ricos de Sysmon** 

Mientras Procmon brinda una visi√≥n en tiempo real, Sysmon ayuda a analizar el historial de eventos relacionados con el proceso sospechoso, proporcionando contexto adicional:

1.	Verificaci√≥n de creaci√≥n del proceso: Examina eventos ProcessCreate en Sysmon para determinar:
o	¬øQu√© proceso gener√≥ el proceso sospechoso?
o	¬øEl proceso tiene un historial asociado a malware conocido?
Ejemplo: Un proceso leg√≠timo (como explorer.exe) podr√≠a haber sido comprometido y utilizado para lanzar el proceso malicioso.
2.	An√°lisis de conexiones de red:
‚Ä¢	Examina eventos de red generados por Sysmon para verificar si el proceso sospechoso:
o	Estableci√≥ conexiones a direcciones IP externas no confiables.
o	Comunic√≥ con servidores ubicados en pa√≠ses con alta incidencia de actividades maliciosas.
3.	Detecci√≥n de flujos secundarios (ADS):
Si el proceso utiliza Alternate Data Streams (ADS) para ocultar su payload, Sysmon registra este comportamiento mediante eventos FileCreateStreamHash. Esto complementa la observaci√≥n en tiempo real de Procmon, que puede haber mostrado una operaci√≥n inusual de creaci√≥n de archivos.

**Paso 3: Conclusi√≥n del an√°lisis** 
Correlacionando los datos de ambas herramientas, el analista puede identificar un patr√≥n claro:
‚Ä¢	Procmon confirma que el proceso realiza cambios sospechosos en el sistema de archivos y el registro.
‚Ä¢	Sysmon refuerza el an√°lisis al mostrar que el proceso fue creado por un ejecutable malicioso y se comunica con un servidor C2.

## 2. ¬øEn Sysmon, ¬øqu√© diferencias existen entre los eventos ProcessCreate y ProcessAccess, y qu√© utilidad tienen cada uno para un analista de seguridad? (5 ptos)
1.	ProcessCreate:
o	Captura informaci√≥n cuando un proceso es creado.
o	Proporciona datos como el nombre del proceso, el usuario que lo inici√≥ y el proceso padre
o	√∫til para identificar c√≥mo se origina un proceso sospechoso.
2.	ProcessAccess:
o	Captura intentos de acceso a otros procesos.
o	Ofrece detalles sobre qu√© proceso intent√≥ acceder y a qu√© proceso espec√≠fico.
o	√ötil para detectar comportamientos maliciosos como intentos de escalaci√≥n de privilegios o inyecciones de c√≥digo.

## 2.1. Describe los atributos principales de ambos eventos.
1.	ProcessCreate:
‚Ä¢	Identificador √∫nico del proceso.
‚Ä¢	Detectar la ejecuci√≥n de procesos inusuales (ej., powershell.exe con argumentos sospechosos).
2.	ProcessAccess:
‚Ä¢	Tipo de acceso (lectura, escritura, ejecuci√≥n).
‚Ä¢	Identificar t√©cnicas de evasi√≥n como inyecciones en procesos leg√≠timos (ej., svchost.exe accediendo a un proceso cr√≠tico)

## 2.2. Investiga y menciona al menos dos escenarios donde cada evento podr√≠a ser clave en la detecci√≥n de amenazas.

Sysmon es una herramienta esencial para la monitorizaci√≥n avanzada de eventos en sistemas Windows, proporcionando visibilidad detallada de actividades cr√≠ticas. Los eventos ProcessCreate (ID 1) y ProcessAccess (ID 10) son particularmente √∫tiles para detectar comportamientos sospechosos y potenciales amenazas. A continuaci√≥n, se presentan dos escenarios para cada evento donde su monitoreo es clave en la detecci√≥n de amenazas:

Evento ProcessCreate (ID 1):

Escenario 1:
‚Ä¢	Ejecuci√≥n de procesos desde ubicaciones inusuales:
Descripci√≥n: La creaci√≥n de procesos desde directorios no est√°ndar, como C:\Temp\ o C:\Users\[Usuario]\AppData\Local\Temp\, puede indicar actividad maliciosa, ya que los atacantes suelen utilizar estas ubicaciones para ejecutar malware.
Detecci√≥n: Monitorear y alertar sobre procesos iniciados desde estas rutas puede ayudar a identificar ejecuciones sospechosas.
Escenario 2: 
‚Ä¢	Uso de argumentos de l√≠nea de comandos sospechosos:

Descripci√≥n: La ejecuci√≥n de comandos con par√°metros inusuales, como powershell.exe -nop -w hidden -enc [cadena], puede ser indicativa de intentos de ofuscaci√≥n o ejecuci√≥n de scripts maliciosos.

Detecci√≥n: Analizar las l√≠neas de comando de los procesos creados permite identificar patrones asociados a t√©cnicas maliciosas.

Evento ProcessAccess (ID 10):
Escenario 1:
‚Ä¢	Acceso al proceso LSASS para extracci√≥n de credenciales:

Descripci√≥n: Herramientas como Mimikatz intentan acceder al proceso lsass.exe para extraer credenciales almacenadas en memoria.

Detecci√≥n: Monitorear accesos al proceso lsass.exe con permisos elevados puede revelar intentos de robo de credenciales. 
Escenario 2:
‚Ä¢	Inyecci√≥n de c√≥digo en procesos leg√≠timos:

Descripci√≥n: Los atacantes pueden inyectar c√≥digo malicioso en procesos confiables para evadir la detecci√≥n y mantener la persistencia en el sistema.
Detecci√≥n: Registrar eventos donde un proceso accede a otro con permisos que permiten escritura o creaci√≥n de hilos puede indicar intentos de inyecci√≥n de c√≥digo. 


<div style="background-color: #f9f9f9; border-left: 6px solid #ccc; padding: 10px;">
  ‚ÑπÔ∏è <strong>Informaci√≥n √∫til:</strong> La configuraci√≥n adecuada de Sysmon para capturar y analizar estos eventos es fundamental en una estrategia de seguridad, permitiendo la detecci√≥n temprana de actividades maliciosas y la implementaci√≥n de medidas de mitigaci√≥n efectivas.
</div>

## 3. En Procmon, ¬øqu√© operaci√≥n(es) corresponde(n) al evento FileCreateStreamHash en Sysmon, y c√≥mo podr√≠as configurarlo en Sysmon para detectar un posible uso malicioso de Alternate Data Streams (ADS)? (5 ptos)
En Procmon (Process Monitor), las operaciones clave relacionadas con ADS incluyen:

`CreateFile:`
Detecta la creaci√≥n o apertura de archivos con flujos alternativos. Ejemplo de un archivo con ADS: archivo.txt:stream.
`WriteFile:`
Identifica cu√°ndo se escriben datos en un flujo alternativo.
`QueryInformationFile:`
Puede revelar accesos sospechosos a archivos con flujos alternativos.
`SetInformationFile:`
Indica cambios en los metadatos de un archivo, lo que podr√≠a incluir la manipulaci√≥n de ADS.
`ReadFile:`
Muestra lecturas de datos desde un flujo alternativo, lo que puede ser parte de una operaci√≥n maliciosa.

### Configuraci√≥n de Sysmon para detectar uso malicioso de ADS
Para detectar un posible uso malicioso de ADS en Sysmon, puedes configurar el archivo XML de reglas para capturar eventos FileCreateStreamHash. Ejemplo de configuraci√≥n:
   ```bash
   <Sysmon schemaversion="4.50">
  <EventFiltering>
    <FileCreateStreamHash onmatch="include">
      <!-- Monitorear solo archivos con flujos alternativos -->
      <Image condition="is">C:\Windows\System32\cmd.exe</Image>
      <TargetFilename condition="contains">:</TargetFilename>
    </FileCreateStreamHash>
  </EventFiltering>
</Sysmon>
   ```
   
Explicaci√≥n del filtro:
`<TargetFilename condition="contains">:</TargetFilename>:`
Detecta cualquier archivo cuyo nombre contenga el car√°cter :, indicando un ADS.
`<Image condition="is">C:\Windows\System32\cmd.exe</Image>:`
Restringe la detecci√≥n a comandos ejecutados desde cmd.exe (puedes ajustar seg√∫n el caso).


<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px;">
  üîî  <strong>Recordatorio Importante:</strong> Ajusta las condiciones de acuerdo con el entorno (ej., rutas cr√≠ticas, herramientas administrativas sospechosas).
</div>

## 3.1. Investiga qu√© son los Alternate Data Streams y por qu√© podr√≠an ser usados por atacantes.
Los Alternate Data Streams (ADS) son flujos adicionales que pueden adjuntarse a archivos en sistemas de archivos NTFS. Los atacantes los usan para esconder datos maliciosos, ya que no son visibles a trav√©s de m√©todos normales de exploraci√≥n de archivos.

## 3.2. Especifica qu√© operaciones de Procmon est√°n relacionadas con este tipo de actividad.
En Procmon, operaciones como:
`CreateFile:` Monitorea cuando un archivo con ADS es creado o accedido.
`WriteFile:` Identifica cu√°ndo se escriben datos en un flujo alternativo.
`QueryInformation:` Muestra intentos de enumerar propiedades del archivo (incluyendo ADS)


## 4. En Sysmon, ¬øqu√© ventajas ofrece el uso de filtros avanzados en comparaci√≥n con capturar todos los eventos de forma indiscriminada? (5 ptos)
‚Ä¢	Reducci√≥n de ruido: Evita recolectar eventos irrelevantes, mejorando la claridad de los logs.
‚Ä¢	Desempe√±o optimizado: Minimiza el impacto en los recursos del sistema al reducir la cantidad de eventos procesados y almacenados.
‚Ä¢	Facilidad de an√°lisis: Facilita la correlaci√≥n y priorizaci√≥n de eventos cr√≠ticos.

## 4.1. Investiga c√≥mo un mal dise√±o de filtros podr√≠a afectar el desempe√±o del sistema y la calidad de los logs.
Sobrecarga del sistema: Capturar todos los eventos puede consumir excesivamente recursos, afectando el rendimiento.
Logs irrelevantes: Generar demasiada informaci√≥n puede ocultar eventos cr√≠ticos, dificultando la detecci√≥n de amenazas.

## 4.2. Proporciona un ejemplo de un filtro efectivo para reducir ruido en un entorno de producci√≥n.

Este filtro en Sysmon est√° dise√±ado para reducir el ruido generado por actividades normales y centrarse en eventos cr√≠ticos en un entorno corporativo. Para lograrlo, excluye procesos y conexiones confiables que suelen ser comunes en sistemas operativos y entornos empresariales. Por ejemplo, elimina de los registros eventos generados por procesos del sistema como dllhost.exe o taskhostw.exe, y navegadores como Chrome o Firefox, que no suelen representar riesgos de seguridad en condiciones normales.
En el caso de conexiones de red, el filtro excluye comunicaciones leg√≠timas que ocurren en puertos comunes como HTTP (80) y HTTPS (443), as√≠ como aquellas realizadas localmente (127.0.0.1). Esto evita que actividades rutinarias inunden los registros, dejando espacio para monitorear conexiones sospechosas o an√≥malas.
Adem√°s, filtra la creaci√≥n de archivos irrelevantes, como los temporales (.tmp) y logs (.log), que no son √∫tiles para an√°lisis de seguridad. En lugar de registrar todos los cambios en el sistema de archivos, se centra en aquellos que pueden representar actividades m√°s importantes o inusuales.
Por otro lado, en cuanto a modificaciones en el registro, solo captura eventos relacionados con claves cr√≠ticas como Run y configuraciones de servicios (Services), que suelen ser utilizadas por atacantes para establecer persistencia en el sistema. Asimismo, el filtro para la carga de im√°genes excluye DLLs y ejecutables de rutas confiables como System32 y Program Files, lo que reduce el ruido al no registrar actividades leg√≠timas y frecuentes.
   ```bash
   <Sysmon schemaversion="4.50">
  <HashAlgorithms>*</HashAlgorithms>
  <EventFiltering>

    <!-- FILTRO PARA CREACI√ìN DE PROCESOS -->
    <ProcessCreate onmatch="exclude">
      <!-- Excluir procesos comunes de Windows -->
      <Image condition="is">C:\Windows\System32\conhost.exe</Image>
      <Image condition="is">C:\Windows\System32\taskhostw.exe</Image>
      <Image condition="is">C:\Windows\System32\dllhost.exe</Image>
      <!-- Excluir navegadores web confiables -->
      <Image condition="begin with">C:\Program Files (x86)\Google\Chrome</Image>
      <Image condition="begin with">C:\Program Files (x86)\Mozilla Firefox</Image>
    </ProcessCreate>

    <!-- FILTRO PARA CONEXIONES DE RED -->
    <NetworkConnect onmatch="exclude">
      <!-- Excluir puertos internos confiables -->
      <DestinationPort condition="is">80</DestinationPort>  <!-- HTTP -->
      <DestinationPort condition="is">443</DestinationPort> <!-- HTTPS -->
      <!-- Excluir conexiones locales -->
      <DestinationIp condition="is">127.0.0.1</DestinationIp>
    </NetworkConnect>

    <!-- FILTRO PARA CREACI√ìN DE ARCHIVOS -->
    <FileCreate onmatch="exclude">
      <!-- Excluir archivos temporales y logs -->
      <TargetFilename condition="end with">.tmp</TargetFilename>
      <TargetFilename condition="end with">.log</TargetFilename>
      <TargetFilename condition="contains">\Temp\</TargetFilename>
    </FileCreate>

    <!-- FILTRO PARA MODIFICACIONES DEL REGISTRO -->
    <RegistryEvent onmatch="include">
      <!-- Incluir solo claves cr√≠ticas -->
      <TargetObject condition="begin with">HKLM\System\CurrentControlSet\Services</TargetObject>
      <TargetObject condition="begin with">HKLM\Software\Microsoft\Windows\CurrentVersion\Run</TargetObject>
      <TargetObject condition="contains">Startup</TargetObject>
    </RegistryEvent>
     <!-- FILTRO PARA BLOQUEOS DE IMAGEN -->
    <ImageLoad onmatch="exclude">
      <!-- Excluir DLLs y ejecutables confiables -->
      <ImageLoaded condition="begin with">C:\Windows\System32</ImageLoaded>
      <ImageLoaded condition="begin with">C:\Program Files</ImageLoaded>
      <ImageLoaded condition="end with">.dll</ImageLoaded>
    </ImageLoad>

  </EventFiltering>
</Sysmon>
 ```
<div style="background-color: #f9f9f9; border-left: 6px solid #ccc; padding: 10px;">
  ‚ÑπÔ∏è <strong>Informaci√≥n √∫til:</strong> Este filtro optimiza los recursos del sistema, mejora la calidad de los registros al centrarse en eventos relevantes, y facilita la detecci√≥n de actividades sospechosas, lo que es crucial en entornos corporativos con alta actividad y necesidades de monitoreo espec√≠ficas.
</div>

### Bibliografia
 1. M. Russinovich y A. Margosis, Troubleshooting with the Windows Sysinternals Tools, 2nd ed., Redmond, WA, USA: Microsoft Press, 2016, ISBN: 978-0-7356-8444-7.
 2. C. Smiliotopoulos, "Use of Sysmon Tool to Detect Lateral Movement Attacks," Tesis de maestr√≠a, Dept. of Information and Communication Systems Eng., Univ. of the Aegean, Samos, Grecia, marzo 2022.
 3. R. Mahmoud, M. Anagnostopoulos, S. Pastrana, y J. M. Pedersen, "Redefiniendo el sandbox de malware: mejorando el an√°lisis mediante la integraci√≥n de Sysmon y ELK," [Manuscrito no publicado], 2023.
 4. C. Marsden, Mastering Sysmon: Deploying, Configuring and Tuning, DFIR Insights. [En l√≠nea]. Disponible en: https://dfirinsights.com. [Accedido: diciembre 2024].

