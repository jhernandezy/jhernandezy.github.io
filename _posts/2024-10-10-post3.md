---
title: PR√ÅCTICA 01
date: 2024-10-11 00:00:00 -05:00
categories: [Ciberseguridad, Seguridad Inform√°tica]
tags: [Kill Chain, Reconnaissance, Weaponization, Exploitation, SSH]  # TAG names should always be lowercase
---

En este post, vamos a explicar los pasos realizados en el laboratorio, y responder las siguientes preguntas relacionadas a cada paso.

# CYBER KILL CHAIN

La Cyber Kill Chain es un modelo fundamental en el √°mbito de la ciberseguridad, desarrollado por Lockheed Martin para describir las etapas que sigue un atacante en un ataque cibern√©tico. Comprender este proceso es esencial para que las organizaciones puedan anticiparse a las amenazas y protegerse de manera efectiva.

![alt text](/assets/images/kil_chain_parts.png)

1. [Reconnaissance]
2. [Weaponization]
3. [Delivery]
4. [Exploitation]
5. [Installation]
6. [Command and Control]
7. [Actions on Objectives]

# RECONNAISSANCE

La etapa de Reconnaissance en la "Cyber Kill Chain" es el primer paso en un ataque cibern√©tico, en la que el atacante recopila informaci√≥n sobre el objetivo para planear su ataque. En esta fase, los cibercriminales investigan y obtienen datos cruciales sobre sistemas, redes, empleados y vulnerabilidades. Esto puede incluir la b√∫squeda de correos electr√≥nicos de empleados, detalles de servidores, vulnerabilidades en el software que usa la organizaci√≥n, o incluso informaci√≥n sobre los h√°bitos laborales de las personas. El objetivo es maximizar las oportunidades de √©xito en fases posteriores del ataque, como la entrega de malware o la explotaci√≥n de vulnerabilidades espec√≠ficas.


<div style="background-color: #f9f9f9; border-left: 6px solid #ccc; padding: 10px;">
  ‚ÑπÔ∏è <strong>Informaci√≥n √∫til:</strong> Los atacantes no solo se limitan a escanear redes. Pueden usar ingenier√≠a social, phishing o t√©cnicas de open-source intelligence (OSINT) para obtener datos valiosos sobre la empresa o sus empleados.
</div>

##  Desarrollo:
En esta primera fase, el atacante utilizar herramientas para recopilar informaci√≥n sobre el objetivo. Un ejemplo com√∫n es el uso de nmap para escanear puertos y detectar servicios en ejecuci√≥n.

## 1. ¬øPor qu√© debemos ejecutar nmap con privilegios de root?

Cuando se utiliza Nmap, una de las herramientas m√°s potentes para el escaneo y la auditor√≠a de redes, es crucial ejecutarlo con privilegios de root. Esto se debe a varias razones que impactan directamente en la efectividad de la herramienta:

**A. Funciones Avanzadas:** Muchas de las capacidades m√°s avanzadas de Nmap, como el SYN scan y otros tipos de escaneo de puertos, requieren acceso a funciones del sistema operativo que solo est√°n disponibles para el usuario root. Esto permite obtener informaci√≥n m√°s detallada sobre los dispositivos en la red.

**B. Detecci√≥n Completa de Servicios:** Ejecutar Nmap como root mejora la precisi√≥n en la identificaci√≥n de servicios y versiones, ya que puede enviar paquetes en niveles m√°s bajos y escuchar respuestas de manera efectiva.

**C. Escaneo Efectivo de Redes Locales:** Al estar en modo promiscuo, Nmap puede descubrir dispositivos y servicios que de otro modo no se podr√≠an identificar sin privilegios de root.

> üí° **Tip √∫til:** Antes de ejecutar Nmap como root, aseg√∫rate de que est√°s en la red adecuada y de que tienes autorizaci√≥n para realizar el escaneo. Esto te ayudar√° a evitar problemas legales o conflictos con pol√≠ticas de seguridad.


Comando para realizar un escaneo de red espec√≠fico utilizando <span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">nmap</span>                
   ```bash
   sudo nmap -sn 10.0.2.4/24
   ```

## 2. ¬øQu√© significan los flags -sS, -sT, -sV, -O en el escaneo de nmap?

Cuando se trata de realizar escaneos con Nmap, comprender los diferentes flags disponibles es fundamental para aprovechar al m√°ximo esta herramienta. Aqu√≠ explicaremos qu√© significan algunos de los flags m√°s utilizados:

‚Ä¢	<span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">-sS</span>: Este flag realiza un escaneo "half-open" o **SYN scan**, que es uno de los m√©todos m√°s comunes y efectivos. Env√≠a un paquete SYN a cada puerto y espera una respuesta:

    1. SYN-ACK: El puerto est√° abierto.
    2. RST: El puerto est√° cerrado.
Este m√©todo es discreto porque no completa la conexi√≥n TCP, lo que lo hace menos detectable por sistemas de seguridad.

Se realiza un escaneo SYN en el host 10.0.2.4

   ```bash
   sudo nmap -sS 10.0.2.4/24 -p 80
   ```
   
Este comando realiza un escaneo de tipo SYN en el puerto 80 del host 10.0.2.4/24.

‚Ä¢	<span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">-sT</span>:El flag -sT ejecuta un escaneo TCP completo, tambi√©n conocido como TCP Connect Scan. Este m√©todo establece una conexi√≥n TCP completa:

Uso: Este m√©todo es m√°s f√°cil de detectar porque establece conexiones completas, pero es √∫til cuando no se tienen privilegios de root y se necesita escanear puertos abiertos.
Ejemplo:
 ```bash
   sudo nmap -sT 10.0.2.4/24 -p 80
   ```
Este comando realiza un escaneo de tipo TCP Connect en el puerto 80 del host 10.0.2.4/24.

‚Ä¢	<span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">-sV</span>: Realiza un escaneo de versi√≥n, que intenta determinar la versi√≥n del servicio que se est√° ejecutando en el puerto. Este tipo de escaneo es √∫til para obtener informaci√≥n adicional sobre el servidor y detectar vulnerabilidades.
Ejemplo:
 ```bash
   sudo nmap -sV 10.0.2.4/24 -p 80
   ```
Este comando realiza un escaneo de versi√≥n en el puerto 80 del host 10.0.2.4/24.

‚Ä¢	<span style="background-color: #f0f0f0; padding: 2px 4px; border-radius: 3px;">-O</span>: Realiza un escaneo de sistema operativo, que intenta determinar el sistema operativo que se est√° ejecutando en el host. Este tipo de escaneo es √∫til para obtener informaci√≥n adicional sobre el host y detectar vulnerabilidades.
Ejemplo:
 ```bash
   sudo nmap -O 10.0.2.4/24
   ```
Este comando realiza un escaneo de sistema operativo en el host 10.0.2.4/24.

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px;">
  üîî  <strong>Recordatorio Importante:</strong> Utiliza estos flags en combinaci√≥n para obtener un perfil m√°s completo de los dispositivos en la red. Por ejemplo, combinar -sS con -sV puede ayudarte a identificar puertos abiertos y los servicios que se ejecutan en ellos.
</div>

## 3. ¬øExiste alg√∫n flag que permite hacer un escaneo involucrando todos los flags mencionados anteriormente?
S√≠, el flag -A combina los flags -sS, -sV y -O para realizar un escaneo exhaustivo.
Ejemplo:
 ```bash
   sudo nmap -A 10.0.2.4/24
   ```
Este comando realiza un escaneo exhaustivo en el host 10.0.2.4/24, que incluye un escaneo de tipo SYN, un escaneo de versi√≥n y un escaneo de sistema operativo.

## 4. Explicar el proceso de un handshake TCP.
El proceso de un handshake TCP (Three-Way Handshake) es el siguiente:
![alt text](/assets/images/HANDSHAKE.png)

1.	El cliente env√≠a un paquete SYN (sincronizaci√≥n) al servidor para iniciar la conexi√≥n.
2.	El servidor responde con un paquete SYN-ACK (sincronizaci√≥n y acknowledgement) que confirma la recepci√≥n del paquete SYN.
3.	El cliente env√≠a un paquete ACK (acknowledgement) que confirma la recepci√≥n del paquete SYN-ACK.
Este proceso se repite para cada conexi√≥n TCP que se establece. El handshake TCP es esencial para establecer una conexi√≥n confiable

## 5. Seg√∫n la pregunta anterior, ¬øqu√© significa el flag -sS?
El flag -sS en Nmap se refiere a un escaneo de tipo SYN, conocido como "half-open scan". Este m√©todo es menos intrusivo que un escaneo de tipo TCP Connect (-sT) porque no completa el proceso de conexi√≥n TCP. En lugar de establecer una conexi√≥n completa, el escaneo SYN env√≠a un paquete SYN al puerto objetivo y espera una respuesta. Si el puerto est√° abierto, el objetivo responde con un paquete SYN-ACK. Si el puerto est√° cerrado, se env√≠a un paquete RST (reset).
Este tipo de escaneo es √∫til porque permite al atacante identificar puertos abiertos sin dejar una conexi√≥n completa en el registro del servidor, lo que puede ayudar a evitar la detecci√≥n.
Ejemplo:
 ```bash
   sudo nmap -sS 10.0.2.15/24 -p 80
   ```
Este comando escanea el puerto 80 del host 10.0.2.15/24 utilizando el m√©todo SYN.

## 6. ¬øQu√© hace el flag --script?
El flag --script permite a Nmap ejecutar scripts de Nmap Scripting Engine (NSE), que son scripts escritos en Lua que pueden realizar una variedad de tareas, desde la detecci√≥n de vulnerabilidades hasta la recopilaci√≥n de informaci√≥n adicional sobre el sistema.
Los scripts pueden ser utilizados para realizar tareas espec√≠ficas como:
‚Ä¢	Detecci√≥n de vulnerabilidades conocidas (por ejemplo, exploits de software).
‚Ä¢	Recolecci√≥n de informaci√≥n sobre servicios (como banners de versi√≥n).
‚Ä¢	Realizaci√≥n de pruebas de seguridad en aplicaciones web.
Existen m√∫ltiples scripts disponibles en Nmap, y se pueden especificar scripts individuales o categor√≠as de scripts.
Ejemplo:
 ```bash
   sudo nmap --script http-vuln* 10.0.2.15/24
   ```
Este comando utiliza Nmap para ejecutar todos los scripts que comienzan con http-vuln en el host 192.168.1.1, buscando vulnerabilidades en servicios HTTP.


# WEAPONIZATION

La etapa de Weaponization en el Cyber Kill Chain es clave para que un atacante convierta la informaci√≥n obtenida en la fase de Reconnaissance en una amenaza activa. Aqu√≠, el atacante crea una "arma" digital (por ejemplo, malware o exploits) que se usar√° para comprometer el sistema objetivo.

## üîß ¬øQu√© ocurre en la fase de Weaponization?
En esta fase, el atacante combina un exploit (una vulnerabilidad aprovechable) con un payload (una carga maliciosa), como un troyano o ransomware, para crear un archivo o herramienta maliciosa que ser√° entregada al objetivo en la siguiente fase del ataque.

Por ejemplo, un documento aparentemente inofensivo de Word podr√≠a tener un exploit que ejecuta c√≥digo malicioso en el sistema objetivo cuando se abre. Sin la etapa de weaponization, un atacante no podr√≠a aprovechar las vulnerabilidades descubiertas en la fase anterior.

<div style="background-color:#ffdddd; border-left: 6px solid #f44336; padding: 10px;">
  <strong>Importante:</strong> La etapa de Weaponization se lleva a cabo fuera de la red de la v√≠ctima, lo que hace que sea complicado detectar al atacante en este punto. Sin embargo, las organizaciones pueden centrarse en la capacitaci√≥n y concienciaci√≥n de los empleados para reconocer archivos sospechosos y evitar la ejecuci√≥n de posibles amenazas.
</div>

##  Desarrollo:
-	Investigar el script utilizado en la enumeraci√≥n de usuarios SSH (auxiliary/scanner/ssh/ssh_enumusers). Responder:
![alt text](/assets/images/weap_ssh.png)

Usa Metasploit para encontrar m√≥dulos relacionados con SSH que te permitan enumerar usuarios. Los siguientes m√≥dulos de Metasploit pueden ser √∫tiles:
auxiliary/scanner/ssh/ssh_enumusers: Este m√≥dulo realiza una enumeraci√≥n de usuarios en el servicio SSH.

  ```bash
    use auxiliary/scanner/ssh/ssh_enumusers
set RHOSTS [IP_ADDRESS]
set USER_FILE [ruta_al_diccionario_de_usuarios]
run

   ```

### 7.	¬øEn qu√© lenguaje de programaci√≥n est√° hecho?
El script ssh_enumusers est√° escrito en Ruby, que es el lenguaje utilizado por el framework Metasploit.

### 8.	C√≥digo del script y explicaci√≥n:
A continuaci√≥n, se presenta una versi√≥n simplificada del c√≥digo del script ssh_enumusers:

 ```bash
 class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::SSH

  def run
    # Enumerar usuarios en el servidor SSH
    ...
  end
end
   ```
Explicaci√≥n breve sobre su funcionamiento:
El script ssh_enumusers se utiliza para enumerar usuarios en un servidor SSH. Funciona intentando autenticarse con una lista de posibles nombres de usuario y determina la validez de cada uno. Si el servidor responde afirmativamente, el script identifica al usuario como v√°lido. Esto es √∫til para identificar cuentas que pueden ser objetivo en la siguiente fase de un ataque.

Investigaci√≥n sobre el script auxiliary/scanner/ssh/ssh_login:
Usa m√≥dulos de Metasploit o herramientas externas como:
auxiliary/scanner/ssh/ssh_login: Este m√≥dulo realiza un ataque de fuerza bruta contra el servicio SSH.

Comando:
  ```bash
use auxiliary/scanner/ssh/ssh_login
set RHOSTS [IP_ADDRESS]
set USER_FILE [ruta_al_diccionario_de_usuarios]
set PASS_FILE [ruta_al_diccionario_de_passwords]
run

  ```

![alt text](/assets/images/SSH_v2.png)

### 9.	¬øEn qu√© lenguaje de programaci√≥n est√° hecho?
El script ssh_login tambi√©n est√° escrito en Ruby, siguiendo la misma estructura que otros scripts de Metasploit. 

### 10.	C√≥digo del script y explicaci√≥n:
A continuaci√≥n, se presenta una versi√≥n simplificada del c√≥digo del script "ssh_login":
  ```bash
class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::SSH

  def run
    # Intentar iniciar sesi√≥n con credenciales
    ...
  end
end
  ```

Explicaci√≥n breve sobre su funcionamiento:
El script ssh_login se utiliza para intentar obtener acceso a un servidor SSH mediante la prueba de diferentes combinaciones de nombres de usuario y contrase√±as. Utiliza la t√©cnica de fuerza bruta o listas de credenciales para determinar si las credenciales son v√°lidas. Si tiene √©xito, el atacante obtiene acceso al sistema objetivo.


# DELIVERY

La etapa de Delivery en el Cyber Kill Chain es el tercer eslab√≥n del ciclo de un ataque cibern√©tico. En esta fase, el atacante entrega la carga maliciosa (malware, exploit, etc.) al sistema o red objetivo. Este es el momento en el que la amenaza llega al entorno de la v√≠ctima, y el √©xito del ataque depende de si logra infiltrarse sin ser detectado.

Esto puede incluir el env√≠o de correos electr√≥nicos de phishing con enlaces maliciosos, la explotaci√≥n de vulnerabilidades en aplicaciones web o el acceso a servicios mal configurados, como SSH. Una vez que se ha logrado la explotaci√≥n, el atacante puede obtener acceso al sistema y comenzar a implementar t√©cnicas adicionales para mantener el acceso y realizar acciones sobre el objetivo.

<div style="background-color: #f9f9f9; border-left: 6px solid #ccc; padding: 10px;">
  ‚ÑπÔ∏è <strong>Informaci√≥n √∫til:</strong> Delivery es una de las pocas fases del Kill Chain donde el atacante interact√∫a directamente con la red objetivo. Si bien la prevenci√≥n es clave, contar con herramientas como firewalls, soluciones de sandboxing y sistemas de detecci√≥n de intrusiones (IDS) puede ayudar a identificar y bloquear los intentos de entrega en tiempo real.
</div>

# D. Exploitation 
La etapa de Exploitation es el cuarto paso en el Cyber Kill Chain y marca el punto en el que el atacante finalmente ejecuta el c√≥digo malicioso dentro del sistema objetivo. En esta fase, se explota una vulnerabilidad previamente identificada para ganar acceso o controlar el sistema. El exploit puede desencadenar la ejecuci√≥n de malware, escalar privilegios, o comprometer una aplicaci√≥n o sistema operativo.

<div style="background-color: #f9f9f9; border-left: 6px solid #ccc; padding: 10px;">
  ‚ÑπÔ∏è <strong>Informaci√≥n √∫til:</strong> Las herramientas de an√°lisis de vulnerabilidades y pruebas de penetraci√≥n (pentesting) son √∫tiles para identificar fallos de seguridad antes de que los atacantes puedan explotarlos. Estas pruebas permiten descubrir y solucionar vulnerabilidades internas de manera proactiva.
</div>

# E. Installation 

-	Describa esta etapa en su blog.
-	Ver el siguiente v√≠deo (activar el traductor de youtube si es que tiene complicaciones con el idioma: Configuraci√≥n > Subt√≠tulos > Traducci√≥n Autom√°tica  > Espa√±ol > Activar subt√≠tulos): https://www.youtube.com/watch?v=ant3ir9cRME. En este v√≠deo, los creadores explican el script vssown.vbs.
-	Proporcionar un breve resumen sobre c√≥mo se puede conciliar malware.
-	Revisar los siguientes links: link1 link2. Explicar, seg√∫n lo descrito en estos blogs, c√≥mo se puede recuperar hashes con el script vssown.vbs.
-	Proporcionar explicaci√≥n sobre el c√≥digo de vssown.vbs (Link).

##  Desarrollo:

### Descripci√≥n de la etapa:
La fase de Installation implica asegurar el acceso persistente en un sistema comprometido. Esto puede lograrse instalando malware, backdoors o scripts que permitan al atacante mantener el control incluso despu√©s de que la sesi√≥n haya terminado. Esta etapa es fundamental para que el atacante pueda volver al sistema en el futuro sin necesidad de repetir el proceso de explotaci√≥n. Los m√©todos comunes incluyen la modificaci√≥n de archivos de inicio, la creaci√≥n de usuarios ocultos o la instalaci√≥n de software malicioso.


Resumen del script vssown.vbs:
### 11.	Proporcionar un breve resumen sobre c√≥mo se puede conciliar malware.
El script vssown.vbs utiliza las instant√°neas de volumen de Windows (VSS) para ocultar el malware en una ubicaci√≥n no f√°cilmente detectable. De esta manera, el malware se oculta en una copia del sistema que se ejecuta autom√°ticamente al iniciar el sistema, permitiendo que el atacante mantenga acceso persistente.
### 12.	Explicar c√≥mo se puede recuperar hashes con el script vssown.vbs.
El script vssown.vbs permite extraer los hashes de las contrase√±as de las cuentas de usuario aprovechando las instant√°neas de volumen de Windows. Esto se logra al acceder a archivos cr√≠ticos del sistema, como el SAM y el SYSTEM, que almacenan informaci√≥n sensible. Al extraer estos archivos, el atacante puede obtener los hashes y proceder a descifrarlos.
###	13. Proporcionar explicaci√≥n sobre el c√≥digo de vssown.vbs:
El  c√≥digo del script vssown.vbs se centra en ocultar malware de manera persistente. A continuaci√≥n se explica su funcionamiento:

-Creaci√≥n de instant√°neas: El script crea una instant√°nea del volumen, lo que permite acceder a una copia de los archivos del sistema en su estado anterior.
-Copia de archivos: El malware se copia en la ubicaci√≥n de la instant√°nea, lo que dificulta su detecci√≥n.
-Ejecuci√≥n persistente: El script configura el sistema para ejecutar el malware autom√°ticamente al iniciar, garantizando acceso continuo al atacante.

# F. Actions on Objective 
Finalmente, el atacante realiza las acciones planeadas, que pueden incluir el robo de informaci√≥n, la manipulaci√≥n de datos o la interrupci√≥n de los servicios.

-	Describa esta etapa en su blog. Solo considerar hasta la etapa de extracci√≥n de los archivos SAM y SYSTEM dado que a√∫n no hemos realizado los pasos para la desencriptaci√≥n y obtenci√≥n del contenido de dichos archivos.
-	Describir qu√© son los archivos SAM y SYSTEM localizados en la carpeta Windows\System32\Config. 
-	¬øC√≥mo es posible extraer la informaci√≥n contenida en los archivos SAM y SYSTEM?

##  Desarrollo:

### Descripci√≥n de la etapa:
La fase de Actions on Objective describe las actividades que un atacante realiza una vez que ha conseguido acceso al sistema. Esto puede incluir la recolecci√≥n de informaci√≥n, la exfiltraci√≥n de datos sensibles, la instalaci√≥n de software adicional o realizar acciones que profundicen el compromiso del sistema. En este caso, nos centraremos en la extracci√≥n de los archivos SAM y SYSTEM, que contienen los hashes de contrase√±as que pueden ser descifrados m√°s adelante.

### 14. Describir qu√© son los archivos SAM y SYSTEM localizados en la carpeta Windows\System32\Config.
Los archivos SAM (Security Account Manager) y SYSTEM son componentes cr√≠ticos del sistema operativo Windows.
-Archivo SAM (Security Account Manager): Almacena los hashes de las contrase√±as de las cuentas de usuario locales en Windows. Estos hashes no est√°n en texto claro, por lo que es necesario descifrarlos para obtener las contrase√±as originales.
-Archivo SYSTEM: Contiene informaci√≥n de configuraci√≥n del sistema y detalles sobre las cuentas de usuario, incluidos los datos necesarios para interpretar los hashes almacenados en el archivo SAM.

### 15. ¬øC√≥mo es posible extraer la informaci√≥n contenida en los archivos SAM y SYSTEM?
Existen varias formas de extraer informaci√≥n de los archivos SAM y SYSTEM:

-Herramientas de extracci√≥n: Herramientas como pwdump, fgdump o chntpw permiten extraer y descifrar los hashes almacenados en estos archivos.
-Scripts: Scripts como vssown.vbs pueden acceder a las instant√°neas de volumen y copiar los archivos SAM y SYSTEM a una ubicaci√≥n accesible para el atacante.
-Uso de Live CDs o entornos de recuperaci√≥n: Los atacantes pueden arrancar el sistema desde un Live CD o un entorno de recuperaci√≥n para acceder a estos archivos sin las restricciones de seguridad impuestas por el sistema operativo.

# Conclusions 

-	Redactar sus conclusiones en las cu√°les debe abordar: 
¬øQu√© es lo que ha aprendido de esta sesi√≥n de laboratorio?
¬øQu√© herramientas nuevas ha a√±adido a sus skills?
Otros temas que Ud. considere importante mencionar.

##  Desarrollo:

### ¬øQu√© es lo que ha aprendido de esta sesi√≥n de laboratorio?
He adquirido conocimientos sobre las distintas fases de un ataque cibern√©tico, desde la recolecci√≥n de informaci√≥n hasta la explotaci√≥n y sustracci√≥n de datos confidenciales. Cada fase cuenta con sus propias herramientas y t√©cnicas, y entender su funcionamiento es esencial para protegerse de estos ataques.

### ¬øQu√© herramientas nuevas ha a√±adido a sus skills?
He fortalecido mis competencias en el uso de Metasploit, particularmente en la ejecuci√≥n de scripts para la enumeraci√≥n de usuarios y la explotaci√≥n de credenciales SSH. Tambi√©n he aprendido a manipular archivos del sistema en Windows para extraer informaci√≥n confidencial.

### Otros temas que Ud. considere importante mencionar.
Resalto la importancia de la seguridad en las contrase√±as y la necesidad de aplicar pol√≠ticas de seguridad estrictas, como el uso de contrase√±as fuertes y la autenticaci√≥n multifactor. Adem√°s, el aprendizaje continuo sobre t√©cnicas de ataque y defensa es clave para mantener un entorno seguro en un contexto cada vez m√°s vulnerable.

